pipeline {
  agent any
  options {
    timestamps()
    disableConcurrentBuilds()
  }

  parameters {
    booleanParam(name: 'CLEAN_BUILD', defaultValue: true, description: 'Clean build (remove node_modules/dist)')
  }

  environment {
    // GitHub
    GIT_REPO_URL       = 'https://github.com/NRKim93/1rmCal_BE.git'
    GIT_BRANCH         = 'main'
    GIT_CREDENTIALS_ID = 'github-pat-jenkins'

    // Build output
    ARTIFACT_NAME = 'deploy_bundle.tar.gz'

    // UMPC target
    UMPC_HOST     = '172.30.1.24'
    UMPC_APP_NAME = 'onerm-backend'
    APP_PORT      = '3001'
    SMOKE_PATH    = '/'

    // Jenkins SSH credential id
    UMPC_SSH_CRED_ID = 'umpc-ssh-key'

    // Jenkins "Secret file" credential id that contains the backend .env
    ENV_FILE_CRED_ID = 'onerm-backend-env'
  }

  stages {
    stage('Clean Workspace') {
      steps { cleanWs() }
    }

    stage('Checkout Source (GitHub)') {
      steps {
        echo "Checkout: ${env.GIT_REPO_URL} (${env.GIT_BRANCH})"
        checkout([
          $class: 'GitSCM',
          branches: [[name: "*/${env.GIT_BRANCH}"]],
          userRemoteConfigs: [[url: env.GIT_REPO_URL, credentialsId: env.GIT_CREDENTIALS_ID]]
        ])
      }
    }

    stage('Install & Build NestJS (Ubuntu)') {
      steps {
        sh '''
          set -eu

          if [ "${CLEAN_BUILD}" = "true" ]; then
            echo "CLEAN_BUILD enabled"
            rm -rf node_modules dist
            find . -name '*.tsbuildinfo' -type f -delete || true
          fi

          node -v
          npm -v
          npm ci
          npx prisma generate
          npm run build

          test -f dist/main.js
          test -f dist/app.module.js
          test -f dist/domain/users/service/oauth.service.js
        '''
      }
    }

    stage('Package Artifact (Ubuntu)') {
      steps {
        sh '''
          set -eu
          npm prune --omit=dev

          rm -rf deploy_bundle
          mkdir -p deploy_bundle/dist

          test -f dist/main.js
          test -d node_modules

          cp -R dist/. deploy_bundle/dist/
          mkdir -p deploy_bundle/node_modules
          cp -R node_modules/. deploy_bundle/node_modules/
          cp -f package.json deploy_bundle/package.json
          if [ -f package-lock.json ]; then
            cp -f package-lock.json deploy_bundle/package-lock.json
          fi
          if [ -d prisma ]; then
            mkdir -p deploy_bundle/prisma
            cp -R prisma/. deploy_bundle/prisma/
          fi

          cat > deploy_bundle/ecosystem.config.cjs <<EOF
module.exports = {
  apps: [{
    name: '${UMPC_APP_NAME}',
    script: 'dist/main.js',
    env: {
      NODE_ENV: 'production',
      PORT: '${APP_PORT}'
    }
  }]
}
EOF

          rm -f "${ARTIFACT_NAME}"
          tar -czf "${ARTIFACT_NAME}" -C deploy_bundle .

          test -f "${ARTIFACT_NAME}"
          ls -l "${ARTIFACT_NAME}"
        '''
      }
    }

    stage('Deploy to UMPC over SSH') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: "${env.UMPC_SSH_CRED_ID}",
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        ), file(credentialsId: "${env.ENV_FILE_CRED_ID}", variable: 'ENV_FILE')]) {
          sh '''
            set -eu

            chmod 600 "$SSH_KEY"

            DEST="${SSH_USER}@${UMPC_HOST}"
            REMOTE_TGZ="/home/${SSH_USER}/${ARTIFACT_NAME}"
            REMOTE_ENV="/home/${SSH_USER}/.onerm-backend.env"
            APP_DIR="/home/${SSH_USER}/apps/${UMPC_APP_NAME}"

            ssh -i "$SSH_KEY" \
              -o IdentitiesOnly=yes \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o ConnectionAttempts=1 \
              -o ServerAliveInterval=15 \
              -o ServerAliveCountMax=2 \
              -o LogLevel=ERROR \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              "$DEST" "mkdir -p '${APP_DIR}'"

            scp -i "$SSH_KEY" \
              -o IdentitiesOnly=yes \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o ConnectionAttempts=1 \
              -o ServerAliveInterval=15 \
              -o ServerAliveCountMax=2 \
              -o LogLevel=ERROR \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              "${ENV_FILE}" \
              "${DEST}:${REMOTE_ENV}"

            scp -i "$SSH_KEY" \
              -o IdentitiesOnly=yes \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o ConnectionAttempts=1 \
              -o ServerAliveInterval=15 \
              -o ServerAliveCountMax=2 \
              -o LogLevel=ERROR \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              "${ARTIFACT_NAME}" \
              "${DEST}:${REMOTE_TGZ}"

            ssh -i "$SSH_KEY" \
              -o IdentitiesOnly=yes \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o ConnectionAttempts=1 \
              -o ServerAliveInterval=15 \
              -o ServerAliveCountMax=2 \
              -o LogLevel=ERROR \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              "$DEST" "bash -s" -- "${REMOTE_TGZ}" "${REMOTE_ENV}" "${APP_DIR}" "${UMPC_APP_NAME}" "${APP_PORT}" <<'EOSSH'
set -euo pipefail

bundle="$1"
env_src="$2"
app_dir="$3"
app_name="$4"
app_port="$5"

if [ ! -f "$bundle" ]; then
  echo "bundle missing: $bundle"
  exit 1
fi
if [ ! -f "$env_src" ]; then
  echo "env missing: $env_src"
  exit 1
fi

if [ -d "$app_dir" ]; then
  backup="${app_dir}.backup.$(date +%Y%m%d_%H%M%S)"
  mv "$app_dir" "$backup"
fi

mkdir -p "$app_dir"
tar -xzf "$bundle" -C "$app_dir"
cp -f "$env_src" "${app_dir}/.env"

cd "$app_dir"
export PORT="$app_port"

test -f "dist/main.js"
test -d "node_modules"

if ! command -v pm2 >/dev/null 2>&1; then
  if ! command -v npm >/dev/null 2>&1; then
    echo "pm2 not found and npm not found on target"
    exit 1
  fi
  sudo -n npm i -g pm2
fi

if command -v lsof >/dev/null 2>&1; then
  pids="$(lsof -ti tcp:"$app_port" || true)"
  if [ -n "$pids" ]; then
    echo "$pids" | xargs -r kill -9
  fi
elif command -v fuser >/dev/null 2>&1; then
  fuser -k -n tcp "$app_port" || true
fi

if [ -f ecosystem.config.cjs ]; then
  pm2 startOrRestart ecosystem.config.cjs --update-env
else
  if pm2 describe "$app_name" >/dev/null 2>&1; then
    pm2 restart "$app_name" --update-env
  else
    pm2 start dist/main.js --name "$app_name"
  fi
fi

pm2 save
pm2 ls --no-color
EOSSH
          '''
        }
      }
    }

    stage('Clean Workspace (after)') {
      steps { cleanWs() }
    }
  }

  post {
    always  { echo 'Pipeline finished.' }
    success { echo 'Deploy succeeded.' }
    failure { echo 'Deploy failed.' }
  }
}
